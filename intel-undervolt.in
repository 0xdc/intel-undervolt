#!/bin/bash

# Copyright (C) 2018 kitsunyan <kitsunyan@inbox.ru>

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <https://www.gnu.org/licenses/>.

indices=()
names=()
values=()
error=

function apply() {
  local index="$1"
  local name="$2"
  local uv="$3"

  grep -Pxq '[0-9a-f]' <<< "$index" || {
    error=1
    echo "Invalid index: '$index'" >&2
    return 1
  }

  [ "${uv:0:1}" = '-' ] && uv="${uv:1}"
  grep -Pxq '\d+(\.\d+)?' <<< "$uv" || {
    error=1
    echo "Invalid index: '$index'" >&2
    return 1
  }

  local value="`awk '{ printf("%x",
  and(lshift(lshift(1, 32) - ($1 * 1.024) + 0.5, 21),
  0xffe00000)) }' <<< "$uv"`"
  [ "$value" = '0' ] && value='00000000'

  grep -Pxq '[0-9a-f]{3}00000' <<< "$value" || {
    error=1
    echo "Invalid value: '$value'" >&2
    return 1
  }

  indices+=("$index")
  names+=("$name")
  values+=("$value")
}

{ source '@SYSCONFDIR@/intel-undervolt.conf' && [ -z "$error" ]; } || {
  echo 'Can not read config file.' >&2
  exit 1
}

function regval() {
  echo "0x80000${2}1${1}${3}"
}

function tomv() {
  awk '{ printf("%0.2f", and(lshift(1, 32) - rshift(strtonum($1), 21), 0x7ff) / 1.024) }' <<< "0x$1"
}

case "$1" in
  read)
    grep -q '^msr ' /proc/modules || modprobe msr
    success=true

    for i in `seq 0 $((${#indices[@]} - 1))`; do
      value="`wrmsr 0x150 "\`regval 0 "${indices[$i]}" 00000000\`" &&
      rdmsr 0x150`"

      [ "$?" = '0' ] && {
        uv="`tomv "$value"`"
        echo "${names[$i]} (${indices[$i]}): -$uv mV"
        true
      } || {
        echo "Failed to read value for ${names[$i]} (${indices[$i]})" >&2
        success=false
      }
    done

    "$success"
    exit $?
    ;;
  apply)
    grep -q '^msr ' /proc/modules || modprobe msr
    success=true

    for i in `seq 0 $((${#indices[@]} - 1))`; do
      value="`wrmsr 0x150 "\`regval 1 "${indices[$i]}" "${values[$i]}"\`" &&
      wrmsr 0x150 "\`regval 0 "${indices[$i]}" 00000000\`" &&
      printf '%08x' "0x\`rdmsr 0x150\`"`"

      [ "$?" = '0' ] && [ "$value" = "${values[$i]}" ] && {
        uv="`tomv "$value"`"
        echo "${names[$i]} (${indices[$i]}): -$uv mV"
        true
      } || {
        echo "Failed to write value for ${names[$i]} (${indices[$i]})" >&2
        success=false
      }
    done

    "$success" && {
      echo 'Success'
      true
    }
    exit $?
    ;;
  *)
    printf '%s\n' \
    'Usage: intel-undervolt COMMAND' \
    '  read      Read and display current values' \
    '  apply     Apply values from config file' \
    >&2
    [ -z "$1" ]
    exit $?
    ;;
esac
